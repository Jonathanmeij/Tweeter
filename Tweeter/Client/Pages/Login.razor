@page "/login"
@attribute [Microsoft.AspNetCore.Authorization.AllowAnonymous]
@using Tweeter.Shared.Models
@inject HttpClient Http
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ILocalStorageService LocalStorageService
@inject NavigationManager NavigationManager

<div class="">
    <div class="flex flex-col items-center justify-center h-screen gap-4">
            <h3 class="text-bold text-2xl">Login</h3>
                        
            <EditForm   Model="user" OnSubmit="HandleLogin"  >
                <div class="flex flex-col max-w-lg gap-2">
                    <div class="flex flex-col">
                        <label  for="email">Email</label>
                        <InputText class="bg-slate-800  p-2 rounded-md border border-slate-700" id="email" @bind-Value="user.Email" />
                    </div>
                    <div class="flex flex-col">
                        <label for="password">Password</label>
                        <InputText class="bg-slate-800 p-2 rounded-md border border-slate-700" type="password" id="password" @bind-Value="user.Password" />
                    </div>
                    <Button OnClickCallback="HandleLogin">Login</Button>
                </div>
            </EditForm>
    </div>
</div>

@code {
    LoginRequest user = new LoginRequest();
    
    async Task HandleLogin()
    {
        var result = await Http.PostAsJsonAsync("/api/auth/login", user);
        var response = await result.Content.ReadFromJsonAsync<LoginResponse>();
        var token = response.Token;
        
        await LocalStorageService.SetItemAsync("token", token);
        await AuthenticationStateProvider.GetAuthenticationStateAsync();
        NavigationManager.NavigateTo("/");
    }
}